<!DOCTYPE html>
<html>
<head>
    <title>å® ç‰©åŠ©æ‰‹</title>
<!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.0/marked.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>

<!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/ir-black.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.2/markdown-it.min.js"></script>



</head>
<body>
<!-- æµ®åŠ¨èŠå¤©æŒ‰é’® -->
<div th:fragment="chatWidget">
<div class="chat-toggle" id="chatToggle">ğŸ’¬</div>

<!-- èŠå¤©çª—å£ -->
<div class="chat-container" id="chatContainer">
    <div class="chat-header">
        <div class="header-left">
                <div>
                <h3>å® ç‰©åŠ©æ‰‹</h3>
            </div>
        </div>
        <div class="header-right">
            <button class="icon-btn" id="historyBtn" title="å†å²è®°å½•">å†å²è®°å½•</button>
            <button class="close-btn" id="closeBtn">Ã—</button>
        </div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
        <input type="text" id="userInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." >
        <button  id="sendBtn" onclick="sendMessage()">å‘é€</button>
    </div>
    <!-- åœ¨chat.htmlçš„bodyèµ·å§‹ä½ç½®æ·»åŠ éšè—å­—æ®µ -->
    <input type="hidden" id="sessionUserId" th:value="${session.Id}">
    <input type="hidden" id="sessionUserName" th:value="${session.Name}">

</div>

<script  th:inline="javascript"   type="module">
    // JavaScript ä»£ç è§ä¸‹æ–‡
    let isChatOpen = false;
    let isWaitingForResponse = false; // æ–°å¢çŠ¶æ€æ ‡å¿—

    // new Mark(context).mark(keyword, options);
    // å¦‚æœå¿…é¡»ä½¿ç”¨æ¨¡å—åŒ–ï¼Œåº”æ”¹ä¸ºï¼š
    import { marked } from 'https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js';
    // åˆ‡æ¢èŠå¤©çª—å£æ˜¾ç¤º/éšè—
    document.getElementById('chatToggle').addEventListener('click', toggleChat);
    document.getElementById('closeBtn').addEventListener('click', toggleChat);
    function toggleChat() {
        const chatContainer = document.getElementById('chatContainer');
        isChatOpen = !isChatOpen;
        chatContainer.style.display = isChatOpen ? 'flex' : 'none';
    }

    // å¤„ç†å›è½¦é”®å‘é€
    // function handleEnter(event) {
    //     if (event.key === 'Enter') {
    //         sendMessage();
    //     }
    // }
    // ç§»é™¤HTMLä¸­çš„onkeypresså±æ€§ï¼Œæ”¹ä¸ºï¼š
    document.getElementById('userInput').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    });
    function checkAuth() {
        const sessionId = document.getElementById('sessionUserId')?.value;
        return sessionId && sessionId !== 'null';
    }

    function showLoginAlert() {
        const messagesDiv = document.getElementById('chatMessages');
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-warning';
        alertDiv.innerHTML = `        è¯·å…ˆ<a href="/login" class="alert-link">ç™»å½•</a>
        æˆ–<a href="/register" class="alert-link">æ³¨å†Œ</a>
        åä½¿ç”¨èŠå¤©åŠŸèƒ½
    `;
        messagesDiv.appendChild(alertDiv);
    }
    // å‘é€æ¶ˆæ¯åˆ°åç«¯
    async function sendMessage() {
        // æ–°å¢è®¤è¯æ£€æŸ¥
        if (!checkAuth()) {
            showLoginAlert();
            return;
        }
        const input = document.getElementById('userInput');
        const prompt = input.value.trim();
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = true;
        if (!prompt) return;
        // çŠ¶æ€æ£€æŸ¥æ‹¦æˆª
        if (isWaitingForResponse || !input.value.trim()) return;

        // é”å®šäº¤äº’æ§ä»¶
        input.disabled = true;
        sendBtn.disabled = true;
        isWaitingForResponse = true;

        // æ¸…ç©ºè¾“å…¥æ¡†
        input.value = '';

        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        appendMessage(prompt, 'user');

        showLoading();
        const uid = getCurrentUserId();

        try {
            // è°ƒç”¨åç«¯æ¥å£ï¼ˆéœ€å¯åŠ¨ Spring Boot æœåŠ¡ï¼‰
            const response = await fetch('http://localhost:8080/ai/chat/'+uid+'/prompt=' + encodeURIComponent(prompt), {
                method: 'POST'
            });

            // å¤„ç†æµå¼å“åº”
            const reader = response.body.getReader();
            let botMessage = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                // è§£ç æµæ•°æ®
                const chunk = new TextDecoder().decode(value);
                botMessage += chunk;

                // å®æ—¶æ›´æ–°æ¶ˆæ¯
                updateBotMessage(botMessage);
            }
        } catch (error) {
            removeLoading();
            appendMessage('è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'bot');

        } finally { // ç¡®ä¿å§‹ç»ˆæ‰§è¡Œ
            input.disabled = false;
            sendBtn.disabled = false;
            isWaitingForResponse = false;
            removeLoading();

            // è¾“å…¥æ¡†é‡æ–°èšç„¦
            setTimeout(() => input.focus(), 50);
        }
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
    function appendMessage(text, sender) {
        const messagesDiv = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;
        // å¤„ç† AI æ¶ˆæ¯
        if (sender === 'bot') {
            messageDiv.innerHTML = processContent(text);
        } else {
            messageDiv.textContent = text;
        }
        // messageDiv.textContent = text;
        // messageDiv.innerHTML = sender === 'bot'
        //     ? DOMPurify.sanitize(marked.parse(text))
        //     : text;
        messagesDiv.appendChild(messageDiv);

        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
    // function processContent(content) {
    //     if (!content) return '';
    //
    //     // ä»…å¤„ç†thinkæ ‡ç­¾çš„é€»è¾‘ï¼ˆå¦‚æœéœ€è¦ä¿ç•™ï¼‰
    //     return content
    //         .replace(/<think>/g, '<div class="think-block">')
    //         .replace(/<\/think>/g, '</div>');
    // }
    marked.use({
        extensions: [{
            name: 'code', // æ˜ç¡®æŒ‡å®šæ‰©å±•åç§°
            renderer(token) {
                return `<pre><code class="hljs">${hljs.highlightAuto(token.text).value}</code></pre>`;
            }
        }]
    });


    // ç§»æ¤å¤„ç†å‡½æ•°
    function processContent(content) {
        if (!content) return '';

        let result = '';
        let isInThinkBlock = false;
        let currentBlock = '';

        // å¤„ç† think æ ‡ç­¾
        for (let i = 0; i < content.length; i++) {
            if (content.slice(i, i + 7) === '<think>') {
                isInThinkBlock = true;
                if (currentBlock) {
                    result += marked.parse(currentBlock);
                }
                currentBlock = '';
                i += 6;
                continue;
            }

            if (content.slice(i, i + 8) === '</think>') {
                isInThinkBlock = false;
                result += `<div class="think-block">${marked.parse(currentBlock)}</div>`;
                currentBlock = '';
                i += 7;
                continue;
            }

            currentBlock += content[i];
        }

        // å¤„ç†å‰©ä½™å†…å®¹
        if (currentBlock) {
            result += isInThinkBlock
                ? `<div class="think-block">${marked.parse(currentBlock)}</div>`
                : marked.parse(currentBlock);
        }

        // // å‡€åŒ– HTML
        // const cleanHtml = DOMPurify.sanitize(result, {
        //     ALLOWED_TAGS: ['div', 'p', 'pre', 'code', 'span', 'strong', 'em', 'ul', 'ol', 'li'],
        //     ALLOWED_ATTR: ['class']
        // });
        // console.log('Sanitized HTML:', cleanHtml); // æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º

        return result;
    }
    // æ›´æ–°æœºå™¨äººçš„æµå¼å“åº”
    function updateBotMessage(text) {
        const messages = document.getElementsByClassName('bot-message');
        const lastMessage = messages[messages.length - 1];

        if (lastMessage) {
            lastMessage.innerHTML = processContent(text);
        } else {
            appendMessage(text, 'bot');
        }
        document.getElementById('chatMessages').scrollTop =
            document.getElementById('chatMessages').scrollHeight;
        // // ä¿æŒæ»šåŠ¨åˆ°åº•éƒ¨
        // const messagesDiv = document.getElementById('chatMessages');
        // messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showLoading() {
        const loading = document.createElement('div');
        loading.className = 'message bot-message';
        loading.innerHTML = '<div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>';
        document.getElementById('chatMessages').appendChild(loading);
    }
    function removeLoading() {
        const loadingElements = document.getElementsByClassName('loading-dots');
        if (loadingElements.length > 0) {
            loadingElements[0].parentElement.remove();  // ç§»é™¤åŠ è½½åŠ¨ç”»å…ƒç´ 
        }
    }
    // æ›¿æ¢åŸæœ‰çš„getCurrentUserIdå‡½æ•°
    function getCurrentUserId() {
        // ä¼˜å…ˆä»æœåŠ¡ç«¯Sessionè·å–
        const sessionId = document.getElementById('sessionUserId')?.value;

        if (sessionId && sessionId !== 'null') {
            // åŒæ­¥åˆ°localStorageä¿æŒå…¼å®¹
            localStorage.setItem('userId', sessionId);
            return sessionId;
        }

        // æœªç™»å½•ç”¨æˆ·å¤„ç†
        let tempId = localStorage.getItem('tempUserId');
        if (!tempId) {
            tempId = generateGuestId();
            localStorage.setItem('tempUserId', tempId);
        }
        return tempId;
    }
    //
    // // åˆ é™¤åŸæœ‰çš„DOMContentLoadedåˆå§‹åŒ–é€»è¾‘
    //
    // // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç”¨æˆ·
    // document.addEventListener('DOMContentLoaded', () => {
    //     if (!getCurrentUserId()) {
    //         // å®ç°ç”¨æˆ·è®¤è¯é€»è¾‘
    //         localStorage.setItem('userId', generateGuestId());
    //     }
    // });
    //
    // function generateGuestId() {
    //     return `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    // }

    document.getElementById('historyBtn').addEventListener('click', async () => {
        const userId = getCurrentUserId();

        // æ·»åŠ è®¤è¯æ£€æŸ¥
        if (userId.startsWith('guest_')) {
            appendMessage('å†å²è®°å½•åŠŸèƒ½éœ€ç™»å½•åä½¿ç”¨', 'system');
            return;
        }

        try {
            const response = await fetch(`/ai/chat/history?userId=${userId}`);
            if (!response.ok) throw new Error('Failed to fetch');
            const history = await response.json();
            showHistoryModal(history);
        } catch (error) {
            appendMessage('è·å–å†å²è®°å½•å¤±è´¥', 'system');
        }
    });

    function showHistoryModal(history) {
        const messagesDiv = document.getElementById('chatMessages');

        // æ¸…ç©ºå½“å‰å¯¹è¯
        messagesDiv.innerHTML = '';

        // æŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤ºå†å²è®°å½•
        history.reverse().forEach(msg => {

            // æ·»åŠ å¸¦æ—¶é—´æˆ³çš„æ¶ˆæ¯
            appendMessageCall(msg.content, msg.role);
        });

        // æ»šåŠ¨åˆ°åº•éƒ¨
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // æ–°å¢å¸¦æ—¶é—´æˆ³çš„æ¶ˆæ¯æ·»åŠ æ–¹æ³•
    function appendMessageCall(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;

        messageDiv.innerHTML = `
        <div class="message-content">${processContent(text)}</div>
    `;

        document.getElementById('chatMessages').appendChild(messageDiv);
    }





</script>
</div>
</body>
</html>
